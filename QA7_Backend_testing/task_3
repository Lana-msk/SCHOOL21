# Задание 3. Базы данных

**Сравнительная таблица**

| Критерий | Реляционные (SQL) | Нереляционные (NoSQL) | Гибридные (NewSQL) |
|----------|-------------------|-----------------------|-------------------|
| **Модель данных** | Таблицы, строки, столбцы | Документы, ключ-значение, графы, колоночные | Комбинация SQL и NoSQL |
| **Схема** | Жесткая, фиксированная | Гибкая, динамическая | Гибкая или фиксированная |
| **Масштабирование** | Вертикальное (scale-up) | Горизонтальное (scale-out) | Оба типа |
| **ACID** | Полная поддержка | BASE (Basically Available, Soft state, Eventually consistent) | Полная ACID + масштабируемость |
| **Примеры** | MySQL, PostgreSQL, Oracle | MongoDB, Redis, Cassandra | CockroachDB, Google Spanner |
| **Использование** | Транзакции, отчеты, сложные запросы | Большие данные, IoT, реальное время | Глобальные распределенные системы |

# Для выбора типа БД:

- Реляционные — когда нужны транзакции и сложные связи

- Документные NoSQL — когда схема меняется часто

- Ключ-значение — для кэша и сессий

- Графовые — для социальных связей и рекомендаций

- Гибридные — для глобальных систем с ACID требованиями

**Гипотеза** (сервис Instagram)

Instagram использует преимущественно реляционные БД для ядра платформы (пользователи, посты, отношения) с дополнением нереляционных БД для специфичных функций (кэш, аналитика, временные данные).

Аргументы и факты:

- Структурированные данные — пользователи, посты, комментарии имеют четкую схему

- Сложные связи — подписки, лайки, теги требуют JOIN операций

- ACID транзакции — критичны для финансовых операций (покупки, промоакции)

- Консистентность — важно, чтобы подписчики видели актуальные данные

- Масштабирование — достигается через шардирование и репликацию

- Известные факты (по публичной информации):

- Исторически использовался PostgreSQL

- Для ленты новостей — Redis (кэш) и Cassandra (масштабируемость)

- Для геоданных и поиска — Elasticsearch

- Для аналитики — Hadoop/HBase

# **Разделение сервиса на ключевые функции:**

**Функция 1: Управление профилями и социальным графом**

Данные:

Профили пользователей (id, username, bio, ссылки)

Подписки/подписчики (граф отношений)

Блокировки, закрытые аккаунты

Тип БД: Реляционная (PostgreSQL)

Почему:

Строгая схема профилей

Сложные запросы (кто подписан на кого, mutual friends)

ACID для обновления профиля

Транзакции при изменении отношений

**Функция 2: Лента новостей (Feed)**

Данные:

Посты от подписок

Временная шкала

Кэшированные данные для быстрого доступа

Ранжирование (алгоритмическая лента)

Тип БД: Гибридный подход

Основное хранение: PostgreSQL (посты, метаданные)

Кэш ленты: Redis (in-memory, быстрый доступ)

Аналитика для ранжирования: Cassandra (масштабируемость)

Почему:

Redis — миллисекундный доступ к кэшированной ленте

Cassandra — горизонтальное масштабирование для аналитики просмотров

PostgreSQL — надежное хранение оригинального контента

**Функция 3: Контент (медиа и взаимодействия)**

Данные:

Фото/видео (метаданные + ссылки на объектное хранилище)

Комментарии и ответы

Лайки, сохранения

Хештеги и геотеги

Тип БД: Комбинация

Метаданные медиа: PostgreSQL (связи, описания)

Лайки/комментарии: Redis (счетчики, быстрые обновления)

Хештеги: Elasticsearch (быстрый поиск)

Геоданные: PostgreSQL + PostGIS

Почему:

Разные паттерны доступа требуют разных БД

Счетчики лайков — высоконагруженные, нужен in-memory

Поиск по хештегам — полнотекстовый поиск

Геопоиск — специализированные GIS функции

# **Тест-кейса для проверки БД**

**Тест 1:** Проверка связей между пользователями (PostgreSQL)
Что делаем:

- Создаем много пользователей (100к) и связей «подписка» (5 млн)

- Запускаем сложные запросы:

- Кто подписан на нас обоих?

- Кто подписан на того, кто подписан на другого (цепочка)?

- У кого больше всего подписчиков?

**Что проверяем:**

Запросы должны выполняться быстро (<0.1 сек)

Данные не «ломаются» при множестве одновременных действий

**Тест 2:** Проверка ленты новостей (PostgreSQL + Redis)
Что делаем:

- Используем две БД: основную (PostgreSQL) и быстрый кэш (Redis)

- Симулируем нагрузку:

- Много людей пишут посты

- Очень много людей читают ленту

- Смотрим разные сценарии: активный пользователь, редкий пользователь, «хайп» вокруг знаменитости

**Что проверяем:**

Лента загружается очень быстро (<0.05 сек)

В 95% случаев данные берутся из быстрого кэша

Кэш и основная БД синхронизированы

**Тест 3:** Проверка аналитики (Cassandra - NoSQL)

Что делаем:

- Используем Cassandra (БД для огромных данных)

- Загружаем 1 миллиард событий «пользователь посмотрел пост»

- Делаем аналитические запросы:

- Какие посты популярны прямо сейчас?

- Сколько пользователей возвращаются?

- Когда люди больше всего активны?

**Что проверяем:**

Система масштабируется: больше серверов = больше мощности

Выдерживает запись 100 000 событий в секунду

Быстро отвечает на запросы даже при гигантских объемах данных